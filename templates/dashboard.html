<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code of the Sea </title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --secondary: #764ba2;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray-100: #f1f5f9;
      --gray-200: #e2e8f0;
      --gray-300: #cbd5e1;
      --gray-400: #94a3b8;
      --gray-500: #64748b;
      --gray-600: #475569;
      --gray-700: #334155;
      --gray-800: #1e293b;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--gray-800);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      color: white;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      font-weight: 700;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
    }

    .card h2 {
      color: var(--gray-800);
      margin-bottom: 20px;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hardware-info {
      grid-column: 1 / -1;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    .info-item {
      background: var(--gray-100);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .info-item:hover {
      background: var(--gray-200);
      transform: scale(1.02);
    }

    .info-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary);
      margin-bottom: 5px;
    }

    .info-label {
      font-size: 0.9rem;
      color: var(--gray-600);
      font-weight: 500;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--warning));
      transition: width 0.3s ease;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status.running {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status.stopped {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .status.warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .status.healthy {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success);
    }

    .status.unhealthy {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .health-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
      padding: 8px;
      background: var(--gray-100);
      border-radius: 8px;
    }

    .health-indicator.healthy {
      border-left: 4px solid var(--success);
    }

    .health-indicator.warning {
      border-left: 4px solid var(--warning);
    }

    .health-indicator.error {
      border-left: 4px solid var(--danger);
    }

    .health-details {
      font-size: 0.9rem;
      color: var(--gray-600);
      margin-top: 5px;
    }

    .health-issues {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
    }

    .health-issues ul {
      margin: 0;
      padding-left: 20px;
      color: var(--danger);
    }

    .health-issues li {
      margin: 5px 0;
    }

    .service-status {
      background: var(--gray-100);
      padding: 15px;
      border-radius: 12px;
      margin: 15px 0;
      border-left: 4px solid var(--primary);
    }

    .service-status h4 {
      color: var(--gray-800);
      margin-bottom: 10px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .service-status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 5px 0;
      border-bottom: 1px solid var(--gray-200);
    }

    .service-status-item:last-child {
      border-bottom: none;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 5px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-start {
      background: var(--success);
      color: white;
    }

    .btn-stop {
      background: var(--danger);
      color: white;
    }

    .btn-save {
      background: var(--info);
      color: white;
    }

    .btn-restart {
      background: var(--warning);
      color: white;
      font-size: 1rem;
      padding: 15px 30px;
    }

    .form-group {
      margin: 15px 0;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--gray-700);
    }

    .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      background: white;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .slider-container {
      margin: 15px 0;
    }

    .slider {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--gray-200);
      outline: none;
      transition: all 0.3s ease;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .slider::-webkit-slider-thumb:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .slider::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .slider-value {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-left: 10px;
      min-width: 50px;
      text-align: center;
    }

    .config-section {
      background: var(--gray-100);
      padding: 20px;
      border-radius: 15px;
      margin-top: 20px;
    }

    .config-section h3 {
      color: var(--gray-800);
      margin-bottom: 15px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }

    .footer {
      text-align: center;
      margin-top: 40px;
    }

    .logs-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
      text-decoration: none;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(102, 126, 234, 0.1);
      transition: all 0.3s ease;
      margin: 5px;
    }

    .logs-link:hover {
      background: rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .temp-normal { color: var(--success); }
    .temp-warm { color: var(--warning); }
    .temp-hot { color: var(--danger); }

    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      
      .info-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-microchip"></i> Code of the Sea : Control Panel</h1>
    
    <!-- Navigation Links -->
    <div style="text-align: center; margin: 20px 0;">
      <a href="/performing" style="
        display: inline-block;
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
        font-size: 16px;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        <i class="fas fa-theater-masks"></i> Performance Mode
      </a>
      <a href="/exhibition/dashboard" style="
        display: inline-block;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        <i class="fas fa-chart-line"></i> Exhibition Monitor
      </a>
      <a href="/system/health" style="
        display: inline-block;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        <i class="fas fa-heartbeat"></i> System Health
      </a>
      <a href="/logs" style="
        display: inline-block;
        background: #6b7280;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        margin: 0 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s;
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        <i class="fas fa-file-alt"></i> System Logs
      </a>
    </div>

    <div class="dashboard-grid">
      <div class="card hardware-info">
        <h2><i class="fas fa-server"></i> System and Environment Information</h2>
        <div class="info-grid">
          <div class="info-item">
            <div class="info-value">{{ "%.1f"|format(hardware_info.cpu_percent) }}%</div>
            <div class="info-label">CPU Usage</div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ hardware_info.cpu_percent }}%"></div>
            </div>
          </div>
          
          <div class="info-item">
            <div class="info-value {% if hardware_info.cpu_temp %}{% if hardware_info.cpu_temp < 60 %}temp-normal{% elif hardware_info.cpu_temp < 75 %}temp-warm{% else %}temp-hot{% endif %}{% endif %}">
              {{ "%.1f°C"|format(hardware_info.cpu_temp) if hardware_info.cpu_temp else "N/A" }}
            </div>
            <div class="info-label">CPU Temperature</div>
          </div>
          
          <div class="info-item">
            <div class="info-value">{{ "%.1f"|format(hardware_info.memory.percent) if hardware_info.memory else "N/A" }}%</div>
            <div class="info-label">Memory Usage</div>
            {% if hardware_info.memory %}
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ hardware_info.memory.percent }}%"></div>
            </div>
            {% endif %}
          </div>
          
          <div class="info-item">
            <div class="info-value">{{ "%.1f"|format(hardware_info.disk.percent) if hardware_info.disk else "N/A" }}%</div>
            <div class="info-label">Disk Usage</div>
            {% if hardware_info.disk %}
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{ hardware_info.disk.percent }}%"></div>
            </div>
            {% endif %}
          </div>
          
          <div class="info-item">
            <div class="info-value">{{ hardware_info.uptime_hours }}h {{ hardware_info.uptime_minutes }}m</div>
            <div class="info-label">System Uptime</div>
          </div>
          
          <div class="info-item">
            <div class="info-value">{{ hardware_info.gpio_in_use }}</div>
            <div class="info-label">Active Services</div>
          </div>
        </div>
        
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <a href="/logs" class="logs-link">
            <i class="fas fa-file-alt"></i> Main Logs
          </a>
          {% for service_name in scripts.keys() %}
          <a href="/service_logs/{{ service_name }}" class="logs-link">
            <i class="fas fa-list"></i> {{ service_name }} Logs
          </a>
          {% endfor %}
        </div>
      </div>


      {% for service_name, script_path in scripts.items() %}
      <div class="card">
        <h2>
          {% if service_name == "LED Service" %}
            💡
          {% elif service_name == "Radio Service" %}
            📻
          {% elif service_name == "Fan Service" %}
            🌪️
          {% elif service_name == "Broadcast Service" %}
            📡
          {% elif service_name == "Mixing Service" %}
            🎙️
          {% endif %}
          {{ service_name }}
        </h2>
        
        <div style="margin-bottom: 15px;">
          <strong>Process Status:</strong>
          {% if service_name in processes %}
            <span class="status running"><i class="fas fa-play-circle"></i> Running (PID: {{ processes[service_name].pid }})</span>
          {% else %}
            <span class="status stopped"><i class="fas fa-stop-circle"></i> Stopped</span>
          {% endif %}
        </div>

        <!-- Enhanced Service Health Display -->
        {% if service_name in service_health %}
        {% set health = service_health[service_name] %}
        <div class="health-indicator {{ 'healthy' if (health.process_running and health.status_fresh and health.service_healthy) else ('warning' if health.process_running else 'error') }}">
          <div style="flex: 1;">
            <strong>Service Health:</strong>
            {% if health.process_running and health.status_fresh and health.service_healthy %}
              <span class="status healthy"><i class="fas fa-heart"></i> Healthy</span>
            {% elif health.process_running and health.status_fresh %}
              <span class="status warning"><i class="fas fa-exclamation-triangle"></i> Running with Issues</span>
            {% elif health.process_running %}
              <span class="status warning"><i class="fas fa-clock"></i> Stale ({{ health.last_seen }})</span>
            {% else %}
              <span class="status unhealthy"><i class="fas fa-times-circle"></i> Not Running</span>
            {% endif %}
            
            <div class="health-details">
              Process: {{ '✓ Running' if health.process_running else '✗ Stopped' }} | 
              Status: {{ '✓ Fresh' if health.status_fresh else '✗ Stale' }} ({{ health.last_seen }}) | 
              Service: {{ '✓ Healthy' if health.service_healthy else '✗ Issues' }}
            </div>
            
            {% if health.issues %}
            <div class="health-issues">
              <strong>Issues Detected:</strong>
              <ul>
                {% for issue in health.issues %}
                <li>{{ issue }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Service Status Display -->
        {% if service_name in service_statuses and service_statuses[service_name] %}
        <div class="service-status">
          <h4><i class="fas fa-info-circle"></i> Service Status</h4>
          {% set status = service_statuses[service_name] %}
          
          {% if service_name == "LED Service" %}
            <div class="service-status-item">
              <span>Mode:</span>
              <span><strong>{{ status.get('mode', 'Unknown') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Brightness:</span>
              <span><strong>{{ "%.1f"|format(status.get('brightness', 0)|float) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Current Light Level:</span>
              <span><strong>{{ "%.1f"|format(status.get('lux_level', 0)) }} lux</strong></span>
            </div>
            <div class="service-status-item">
              <span>Power:</span>
              <span class="status {{ 'running' if status.get('power_state') else 'stopped' }}">
                {{ 'ON' if status.get('power_state') else 'OFF' }}
              </span>
            </div>
            <div class="service-status-item">
              <span>Connection:</span>
              <span class="status {{ 'running' if status.get('connection_status') == 'connected' else 'error' }}">
                {{ status.get('connection_status', 'Unknown').upper() }}
              </span>
            </div>
          {% elif service_name == "Radio Service" %}
            <div class="service-status-item">
              <span>Mode:</span>
              <span><strong>{{ status.get('mode', 'Unknown') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Frequency:</span>
              <span><strong>{{ "%.2f"|format(status.get('frequency', 0)) }} MHz</strong>
                {% if status.get('requested_frequency') and status.get('frequency_difference') is not none %}
                  {% if status.get('frequency_error') %}
                    <span style="color: #dc2626; font-size: 12px;">
                      ⚠️ (req: {{ "%.2f"|format(status.get('requested_frequency')) }} MHz, diff: {{ "%.3f"|format(status.get('frequency_difference')) }})
                    </span>
                  {% else %}
                    <span style="color: #10b981; font-size: 12px;">
                      ✓ (diff: {{ "%.3f"|format(status.get('frequency_difference')) }} MHz)
                    </span>
                  {% endif %}
                {% endif %}
              </span>
            </div>
            <div class="service-status-item">
              <span>Signal Level:</span>
              <span><strong>{{ status.get('signal_level', 0) }}/15</strong></span>
            </div>
            <div class="service-status-item">
              <span>Connection:</span>
              <span class="status {{ 'running' if status.get('connection_status') == 'connected' else 'error' }}">
                {{ status.get('connection_status', 'Unknown').upper() }}
              </span>
            </div>
          {% elif service_name == "Fan Service" %}
            <div class="service-status-item">
              <span>Mode:</span>
              <span><strong>{{ status.get('mode', 'Unknown') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Current Speed:</span>
              <span><strong>{{ "%.1f"|format(status.get('speed', 0)) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Target Speed:</span>
              <span><strong>{{ "%.1f"|format(status.get('target_speed', 0)) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Connection:</span>
              <span class="status {{ 'running' if status.get('connection_status') == 'connected' else 'error' }}">
                {{ status.get('connection_status', 'Unknown').upper() }}
              </span>
            </div>
          {% elif service_name == "Broadcast Service" %}
            <div class="service-status-item">
              <span>Mode:</span>
              <span><strong>{{ status.get('mode', 'Unknown') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Current File:</span>
              <span><strong>{{ status.get('current_file', 'None') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Playing:</span>
              <span class="status {{ 'running' if status.get('playing') else 'stopped' }}">
                {{ 'Yes' if status.get('playing') else 'No' }}
              </span>
            </div>
            <div class="service-status-item">
              <span>Playlist:</span>
              <span><strong>{{ status.get('playlist', [])|length }} files</strong></span>
            </div>
            <div class="service-status-item">
              <span>Volume:</span>
              <span><strong>{{ status.get('volume', 50) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Connection:</span>
              <span class="status {{ 'running' if status.get('connection_status') == 'connected' else 'error' }}">
                {{ status.get('connection_status', 'Unknown').upper() }}
              </span>
            </div>
            
            <!-- Broadcast Service Playlist Management -->
            <div class="broadcast-playlist" style="margin-top: 15px;">
              <h4 style="margin: 10px 0; color: #374151;">📁 Playlist Files</h4>
              
              
              <!-- MP3 Player Controls -->
              <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                <!-- Status Display -->
                <div style="text-align: center; margin-bottom: 10px;">
                  <div style="color: #374151; font-weight: bold; font-size: 16px;">
                    {% if status.get('current_file') %}
                      🎵 {{ status.get('current_file') }}
                    {% else %}
                      📂 No file selected
                    {% endif %}
                  </div>
                  <div style="color: #6b7280; font-size: 14px; margin-top: 5px;">
                    {% if status.get('playing') %}
                      <span style="color: #10b981;">▶️ Playing</span>
                    {% elif status.get('paused') %}
                      <span style="color: #f59e0b;">⏸️ Paused</span>
                    {% else %}
                      <span style="color: #6b7280;">⏹️ Stopped</span>
                    {% endif %}
                    • Track {{ (status.get('current_index', 0) + 1) }} of {{ status.get('playlist', [])|length }}
                  </div>
                </div>
                
                <!-- Player Controls -->
                <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                  <!-- Previous Button -->
                  <form action="{{ url_for('broadcast_control', action='previous') }}" method="post" style="display: inline;">
                    <button type="submit" title="Previous Track" 
                            style="background: #6b7280; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                      ⏮️
                    </button>
                  </form>
                  
                  <!-- Play/Pause Button -->
                  {% if status.get('playing') %}
                    <form action="{{ url_for('broadcast_control', action='pause') }}" method="post" style="display: inline;">
                      <button type="submit" title="Pause" 
                              style="background: #f59e0b; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        ⏸️
                      </button>
                    </form>
                  {% else %}
                    <form action="{{ url_for('broadcast_control', action='play') }}" method="post" style="display: inline;">
                      <button type="submit" title="Play" 
                              style="background: #10b981; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        ▶️
                      </button>
                    </form>
                  {% endif %}
                  
                  <!-- Stop Button -->
                  <form action="{{ url_for('broadcast_control', action='stop') }}" method="post" style="display: inline;">
                    <button type="submit" title="Stop" 
                            style="background: #ef4444; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                      ⏹️
                    </button>
                  </form>
                  
                  <!-- Next Button -->
                  <form action="{{ url_for('broadcast_control', action='next') }}" method="post" style="display: inline;">
                    <button type="submit" title="Next Track" 
                            style="background: #6b7280; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; font-size: 16px;">
                      ⏭️
                    </button>
                  </form>
                </div>

                <!-- Web Audio Player -->
                {% if status.get('current_file') %}
                <div style="margin-top: 15px; text-align: center;">
                  <h5 style="margin: 10px 0; color: #374151;">🎧 Web Playback</h5>
                  <audio controls style="width: 100%; max-width: 400px;">
                    <source src="{{ url_for('serve_media', filename=status.get('current_file')) }}" type="audio/mpeg">
                    <source src="{{ url_for('serve_media', filename=status.get('current_file')) }}" type="audio/wav">
                    Your browser does not support the audio element.
                  </audio>
                  <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">
                    Click play to listen to the current broadcast audio in your web browser
                  </div>
                </div>
                {% endif %}
              </div>
              
              <!-- Playlist Display -->
              {% if status.get('playlist') %}
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 5px; padding: 10px;">
                  {% for file in status.get('playlist', []) %}
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #f3f4f6;">
                      <span style="flex: 1; {{ 'font-weight: bold; color: #10b981;' if file == status.get('current_file') else '' }}">
                        {{ '▶️' if file == status.get('current_file') else '🎵' }} {{ file }}
                      </span>
                      <form action="{{ url_for('delete_broadcast_file') }}" method="post" style="display: inline;">
                        <input type="hidden" name="filename" value="{{ file }}">
                        <button type="submit" onclick="return confirm('Delete {{ file }}?')" 
                                style="background: #ef4444; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                          🗑️
                        </button>
                      </form>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div style="text-align: center; color: #6b7280; padding: 20px; border: 2px dashed #d1d5db; border-radius: 5px;">
                  📂 No audio files in playlist<br>
                  <small>Upload some audio files to get started!</small>
                </div>
              {% endif %}
            </div>
          {% elif service_name == "Mixing Service" %}
            <div class="service-status-item">
              <span>Mode:</span>
              <span><strong>{{ status.get('mode', 'Unknown') }}</strong></span>
            </div>
            <div class="service-status-item">
              <span>Status:</span>
              <span class="status {{ 'running' if status.get('status') in ['recording', 'mixing', 'preparing'] else ('success' if status.get('status') == 'completed' else 'stopped') }}">
                {% if status.get('status') == 'recording' %}
                  🎙️ Recording
                {% elif status.get('status') == 'mixing' %}
                  🎛️ Mixing
                {% elif status.get('status') == 'preparing' %}
                  ⚙️ Preparing
                {% elif status.get('status') == 'completed' %}
                  ✅ Completed
                {% elif status.get('status') == 'waiting' %}
                  ⏳ Waiting
                {% else %}
                  {{ status.get('status', 'Unknown').title() }}
                {% endif %}
              </span>
            </div>
            <div class="service-status-item">
              <span>Master Volume:</span>
              <span><strong>{{ status.get('master_volume', 0) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Mic Volume:</span>
              <span><strong>{{ status.get('mic_volume', 0) }}%</strong></span>
            </div>
            <div class="service-status-item">
              <span>Mixed Files:</span>
              <span><strong>{{ status.get('mixed_files_count', 0) }} files</strong></span>
            </div>
            {% if status.get('latest_output_file') %}
            <div class="service-status-item">
              <span>Latest Output:</span>
              <span><strong>{{ status.get('latest_output_file') }}</strong></span>
            </div>
            {% endif %}
            {% if status.get('master_duration') and status.get('master_position') is not none %}
            <div class="service-status-item">
              <span>Master Position:</span>
              <span><strong>{{ "%.0f"|format(status.get('master_position', 0)) }}s / {{ "%.0f"|format(status.get('master_duration', 0)) }}s</strong>
                <small style="color: #6b7280;">({{ "%.1f"|format((status.get('master_position', 0) / status.get('master_duration', 1)) * 100) }}%)</small>
              </span>
            </div>
            {% endif %}
          {% endif %}

          {% if status.get('error_count', 0) > 0 %}
          <div class="service-status-item">
            <span>Errors:</span>
            <span class="status error">{{ status.get('error_count', 0) }} errors</span>
          </div>
          {% endif %}
          
          {% if status.get('last_update') %}
          <div class="service-status-item">
            <span>Last Update:</span>
            <span><small>{{ status.get('last_update', 'Never')[:19] }}</small></span>
          </div>
          {% endif %}
        </div>
        {% endif %}
        
        <div class="button-group">
          <form action="{{ url_for('start_service', service=service_name) }}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-start">
              <i class="fas fa-play"></i> Start
            </button>
          </form>
          <form action="{{ url_for('stop_service', service=service_name) }}" method="post" style="display: inline;">
            <button type="submit" class="btn btn-stop">
              <i class="fas fa-stop"></i> Stop
            </button>
          </form>
        </div>

        <div class="config-section">
          <h3><i class="fas fa-cog"></i> Configuration</h3>
          <form action="{{ url_for('save_service_config', service=service_name) }}" method="post">
            {% if service_name == "LED Service" %}
              <div class="form-group">
                <label class="form-label">Mode:</label>
                <select name="mode" class="form-select" required onchange="toggleSliders(this.value, '{{ service_name }}')">
                  <option value="Lux sensor" {% if configs[service_name]["mode"] in ["Lighting LED", "Lux sensor"] %}selected{% endif %}>Lux sensor</option>
                  <option value="Manual LED" {% if configs[service_name]["mode"]=="Manual LED" %}selected{% endif %}>Manual LED</option>
                  <option value="Musical LED" {% if configs[service_name]["mode"]=="Musical LED" %}selected{% endif %}>Musical LED</option>
                  <option value="Disable" {% if configs[service_name]["mode"]=="Disable" %}selected{% endif %}>Disable</option>
                </select>
              </div>
              <div class="form-group" id="ledBrightnessGroup" style="display: {% if configs[service_name]['mode'] == 'Manual LED' %}block{% else %}none{% endif %};">
                <label class="form-label">Brightness:</label>
                <div class="slider-container">
                  <input type="range" name="brightness" min="0" max="100" value="{{ configs[service_name]['brightness'] }}" 
                         class="slider" id="brightnessSlider" oninput="updateSliderValue('brightnessSlider', 'brightnessValue')">
                  <span class="slider-value" id="brightnessValue">{{ configs[service_name]['brightness'] }}%</span>
                </div>
              </div>
              <!-- Lux Range Configuration for Lux sensor mode -->
              <div class="form-group" id="ledLuxRangeGroup" style="display: {% if configs[service_name]['mode'] in ['Lighting LED', 'Lux sensor'] %}block{% else %}none{% endif %};">
                <label class="form-label">Lux Range Configuration:</label>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 10px;">
                  <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">
                    Configure the light range for brightness control: low lux = high brightness, high lux = low brightness
                  </div>

                  <div style="margin-bottom: 10px;">
                    <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Min Lux (100% brightness):</label>
                    <div class="slider-container">
                      <input type="range" name="lux_min" min="1" max="500" step="1" value="{{ configs[service_name].get('lux_min', 20) }}"
                             class="slider" id="luxMinSlider" oninput="updateSliderValue('luxMinSlider', 'luxMinValue')">
                      <span class="slider-value" id="luxMinValue">{{ configs[service_name].get('lux_min', 20) }} lux</span>
                    </div>
                  </div>

                  <div>
                    <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Max Lux (0% brightness):</label>
                    <div class="slider-container">
                      <input type="range" name="lux_max" min="100" max="5000" step="50" value="{{ configs[service_name].get('lux_max', 1500) }}"
                             class="slider" id="luxMaxSlider" oninput="updateSliderValue('luxMaxSlider', 'luxMaxValue')">
                      <span class="slider-value" id="luxMaxValue">{{ configs[service_name].get('lux_max', 1500) }} lux</span>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Microphone Threshold Configuration for Musical LED mode -->
              <div class="form-group" id="ledMicThresholdGroup" style="display: {% if configs[service_name]['mode'] == 'Musical LED' %}block{% else %}none{% endif %};">
                <label class="form-label">Automatic Microphone Control:</label>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; margin-bottom: 10px;">
                  <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">
                    Current microphone thresholds for automatic brightness control
                    <span style="color: #10b981; font-weight: 600;">● Live (automatically reloaded)</span>
                  </div>

                  <div style="margin-bottom: 10px;">
                    <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Quiet Threshold:</label>
                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db;">
                      <span style="font-weight: bold; color: #374151;">{{ configs[service_name].get('mic_rms_quiet', '0.005') }}</span>
                      <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">RMS level</span>
                    </div>
                  </div>

                  <div>
                    <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Loud Threshold:</label>
                    <div style="background: white; padding: 10px; border-radius: 6px; border: 1px solid #d1d5db;">
                      <span style="font-weight: bold; color: #374151;">{{ configs[service_name].get('mic_rms_loud', '0.03') }}</span>
                      <span style="color: #6b7280; font-size: 12px; margin-left: 8px;">RMS level</span>
                    </div>
                  </div>

                  <!-- Below Threshold Behavior Configuration -->
                  <div style="margin-top: 15px;">
                    <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Below Quiet Threshold Behavior:</label>
                    <select name="musical_led_below_threshold" class="form-select" style="margin-bottom: 10px;" onchange="toggleMinimumBrightness(this.value)">
                      <option value="off" {% if configs[service_name].get('musical_led_below_threshold', 'off') == 'off' %}selected{% endif %}>Turn LED OFF</option>
                      <option value="minimum" {% if configs[service_name].get('musical_led_below_threshold', 'off') == 'minimum' %}selected{% endif %}>Keep LED ON at minimum brightness</option>
                    </select>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">
                      Choose whether the LED turns off completely or stays on at minimum brightness when sound is below the quiet threshold.
                    </div>

                    <div id="minimumBrightnessGroup" style="display: {% if configs[service_name].get('musical_led_below_threshold', 'off') == 'minimum' %}block{% else %}none{% endif %};">
                      <label class="form-label" style="font-size: 14px; margin-bottom: 5px;">Minimum Brightness:</label>
                      <div class="slider-container">
                        <input type="range" name="musical_led_minimum_brightness" min="1" max="20" value="{{ configs[service_name].get('musical_led_minimum_brightness', '3') }}"
                               class="slider" id="minimumBrightnessSlider" oninput="updateSliderValue('minimumBrightnessSlider', 'minimumBrightnessValue')">
                        <span class="slider-value" id="minimumBrightnessValue">{{ configs[service_name].get('musical_led_minimum_brightness', '3') }}%</span>
                      </div>
                      <div style="color: #6b7280; font-size: 12px;">
                        LED brightness when sound is below quiet threshold (1-20%).
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% elif service_name == "Radio Service" %}
              <!-- Current Station Display -->
              <div class="form-group">
                <label class="form-label">Current Station:</label>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0; text-align: center;">
                  <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">
                    📻
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('frequency') %}
                      {{ "%.1f"|format(service_statuses[service_name]['frequency']) }} MHz
                    {% else %}
                      {{ "%.1f"|format(configs[service_name]['frequency']) }} MHz
                    {% endif %}
                  </div>
                  <div style="font-size: 14px; color: #6b7280;">
                    Mode:
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') %}
                      {{ service_statuses[service_name]['mode'] }}
                    {% else %}
                      {{ configs[service_name]['mode'] }}
                    {% endif %}
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('signal_level') is not none %}
                      • Signal: {{ service_statuses[service_name]['signal_level'] }}/15
                      <span style="color: {% if service_statuses[service_name]['signal_level'] >= 12 %}#10b981{% elif service_statuses[service_name]['signal_level'] >= 8 %}#f59e0b{% else %}#ef4444{% endif %}; font-family: monospace; margin-left: 8px;">
                        {% set signal = service_statuses[service_name]['signal_level'] %}
                        {% for i in range(5) %}
                          {% if i < (signal / 3) %}█{% else %}░{% endif %}
                        {% endfor %}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Radio Mode Selection -->
              <div class="form-group">
                <label class="form-label">Radio Mode:</label>
                <select name="mode_selector" class="form-select" onchange="setRadioMode(this.value)" style="margin-bottom: 15px;">
                  <option value="Fixed" {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Fixed') or (configs[service_name]['mode'] == 'Fixed') %}selected{% endif %}>Manual Frequency</option>
                  <option value="Scan" {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') in ['Scan', 'Scanning', 'Scanned']) or (configs[service_name]['mode'] == 'Scan') %}selected{% endif %}>Scan Once</option>
                  <option value="Loop" {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Loop') or (configs[service_name]['mode'] == 'Loop') %}selected{% endif %}>Loop Stations</option>
                  <option value="Disable" {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Disable') or (configs[service_name]['mode'] == 'Disable') %}selected{% endif %}>Disable</option>
                </select>
              </div>

              <!-- Loop Duration Control -->
              <div class="form-group" id="loopDurationGroup" style="display: {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Loop') or (configs[service_name]['mode'] == 'Loop') %}block{% else %}none{% endif %};">
                <label class="form-label">Loop Duration (seconds per station):</label>
                <div class="slider-container">
                  <input type="range" name="loop_duration" min="1" max="300" step="1"
                         value="{% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('loop_duration') %}{{ service_statuses[service_name]['loop_duration'] }}{% else %}{{ configs[service_name].get('loop_duration', 30) }}{% endif %}"
                         class="slider" id="loopDurationSlider" oninput="updateLoopDurationSlider(); updateLoopDuration();">
                  <span class="slider-value" id="loopDurationValue">
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('loop_duration') %}{{ service_statuses[service_name]['loop_duration'] }}{% else %}{{ configs[service_name].get('loop_duration', 30) }}{% endif %}s
                  </span>
                </div>
              </div>

              <!-- Loop Status Display -->
              <div class="form-group" id="loopStatusGroup" style="display: {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Loop') %}block{% else %}none{% endif %};">
                <label class="form-label">Loop Status:</label>
                <div style="background: #f8fafc; padding: 15px; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <div id="loopStatus">
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Loop' %}
                      <div style="font-size: 14px; color: #1f2937; margin-bottom: 8px;">
                        🔄 Station {{ (service_statuses[service_name].get('current_station_index', 0) + 1) }} of {{ service_statuses[service_name].get('stations', [])|length }}
                      </div>
                      <div style="font-size: 12px; color: #6b7280;">
                        Time remaining: {{ service_statuses[service_name].get('time_remaining', 0)|round }}s
                      </div>
                    {% else %}
                      <div style="font-size: 14px; color: #6b7280; text-align: center;">
                        Select Loop mode to cycle through stations
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Found Stations List -->
              <div class="form-group" id="stationsList" style="display: block;">
                <label class="form-label">Found Stations:</label>
                <div id="stationsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px; background: #f8fafc;">
                  <!-- Stations will be populated here -->
                  <div style="text-align: center; padding: 20px; color: #6b7280;" id="defaultStationsMessage">
                    {% if (service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('mode') == 'Scanned') %}
                      <i class="fas fa-radio"></i> Loading station list...
                    {% else %}
                      <i class="fas fa-info-circle"></i> Select "Scan Once" to find all stations
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Manual Frequency Control -->
              <div class="form-group">
                <label class="form-label">Manual Frequency:</label>
                <div class="slider-container">
                  <input type="range" name="frequency" min="87.0" max="108.0" step="0.1"
                         value="{% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('frequency') %}{{ service_statuses[service_name]['frequency'] }}{% else %}{{ configs[service_name]['frequency'] }}{% endif %}"
                         class="slider" id="frequencySlider" oninput="updateSliderValue('frequencySlider', 'frequencyValue')">
                  <span class="slider-value" id="frequencyValue">
                    {% if service_name in service_statuses and service_statuses[service_name] and service_statuses[service_name].get('frequency') %}
                      {{ "%.1f"|format(service_statuses[service_name]['frequency']) }} MHz
                    {% else %}
                      {{ configs[service_name]['frequency'] }} MHz
                    {% endif %}
                  </span>
                </div>
                <input type="hidden" name="mode" id="hiddenMode" value="Fixed">
                <input type="hidden" name="direction" value="Up">
              </div>
            {% elif service_name == "Fan Service" %}
              <div class="form-group">
                <label class="form-label">Mode:</label>
                <select name="mode" class="form-select" required onchange="toggleSliders(this.value, '{{ service_name }}')">
                  <option value="Fixed" {% if configs[service_name]["mode"]=="Fixed" %}selected{% endif %}>Fixed</option>
                  <option value="Sounding" {% if configs[service_name]["mode"]=="Sounding" %}selected{% endif %}>Sounding</option>
                  <option value="Disable" {% if configs[service_name]["mode"]=="Disable" %}selected{% endif %}>Disable</option>
                </select>
              </div>
              <div class="form-group" id="fanSpeedGroup" style="display: {% if configs[service_name]['mode'] == 'Fixed' %}block{% else %}none{% endif %};">
                <label class="form-label">Speed:</label>
                <div class="slider-container">
                  <input type="range" name="speed" min="0" max="100" value="{{ configs[service_name]['speed'] }}" 
                         class="slider" id="speedSlider" oninput="updateSliderValue('speedSlider', 'speedValue')">
                  <span class="slider-value" id="speedValue">{{ configs[service_name]['speed'] }}%</span>
                </div>
              </div>
            {% elif service_name == "Broadcast Service" %}
              <div class="form-group">
                <label class="form-label">Mode:</label>
                <select name="mode" class="form-select" required>
                  <option value="Loop" {% if configs[service_name]["mode"]=="Loop" %}selected{% endif %}>Loop</option>
                  <option value="Random" {% if configs[service_name]["mode"]=="Random" %}selected{% endif %}>Random</option>
                  <option value="Disable" {% if configs[service_name]["mode"]=="Disable" %}selected{% endif %}>Disable</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Volume:</label>
                <div class="slider-container">
                  <input type="range" name="volume" min="0" max="100" value="{{ configs[service_name]['volume'] }}" 
                         class="slider" id="volumeSlider" oninput="updateSliderValue('volumeSlider', 'volumeValue')">
                  <span class="slider-value" id="volumeValue">{{ configs[service_name]['volume'] }}%</span>
                </div>
              </div>
            {% elif service_name == "Mixing Service" %}
              <div class="form-group">
                <label class="form-label">Mode:</label>
                <select name="mode" class="form-select" required>
                  <option value="Auto" {% if configs[service_name]["mode"]=="Auto" %}selected{% endif %}>Auto</option>
                  <option value="Once" {% if configs[service_name]["mode"]=="Once" %}selected{% endif %}>Once</option>
                  <option value="Disable" {% if configs[service_name]["mode"]=="Disable" %}selected{% endif %}>Disable</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Master Volume:</label>
                <div class="slider-container">
                  <input type="range" name="master_volume" min="0" max="100" value="{{ configs[service_name]['master_volume'] }}"
                         class="slider" id="masterVolumeSlider" oninput="updateSliderValue('masterVolumeSlider', 'masterVolumeValue')">
                  <span class="slider-value" id="masterVolumeValue">{{ configs[service_name]['master_volume'] }}%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Microphone Volume:</label>
                <div class="slider-container">
                  <input type="range" name="mic_volume" min="0" max="100" value="{{ configs[service_name]['mic_volume'] }}"
                         class="slider" id="micVolumeSlider" oninput="updateSliderValue('micVolumeSlider', 'micVolumeValue')">
                  <span class="slider-value" id="micVolumeValue">{{ configs[service_name]['mic_volume'] }}%</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Recording Duration:</label>
                <div class="slider-container">
                  <input type="range" name="recording_duration" min="10" max="300" step="10" value="{{ configs[service_name]['recording_duration'] if configs[service_name].get('recording_duration') else 30 }}"
                         class="slider" id="recordingDurationSlider" oninput="updateSliderValue('recordingDurationSlider', 'recordingDurationValue')">
                  <span class="slider-value" id="recordingDurationValue">{{ configs[service_name]['recording_duration'] if configs[service_name].get('recording_duration') else 30 }}s</span>
                </div>
                <div style="color: #6b7280; font-size: 12px; margin-top: 5px;">
                  Duration of each microphone recording and master audio segment (10-300 seconds)
                </div>
              </div>
            {% endif %}
            <button type="submit" class="btn btn-save">
              <i class="fas fa-save"></i> Save Configuration
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="footer">
      <form action="{{ url_for('restart_pi') }}" method="post" 
            onsubmit="return confirm('Are you sure you want to restart the Raspberry Pi?');">
        <button type="submit" class="btn btn-restart">
          <i class="fas fa-power-off"></i> Restart Raspberry Pi
        </button>
      </form>
      <p style="margin-top: 20px; color: rgba(255,255,255,0.8);">
        <small><i class="fas fa-code"></i> Dashboard v{{ app_version }}</small>
      </p>
    </div>
  </div>

  <script>
    function updateSliderValue(sliderId, valueId) {
      const slider = document.getElementById(sliderId);
      const valueElement = document.getElementById(valueId);
      let value = slider.value;
      
      if (sliderId === 'frequencySlider') {
        valueElement.textContent = value + ' MHz';
      } else if (sliderId === 'recordingDurationSlider') {
        valueElement.textContent = value + 's';
      } else if (sliderId === 'luxMinSlider' || sliderId === 'luxMaxSlider') {
        valueElement.textContent = value + ' lux';
      } else {
        valueElement.textContent = value + '%';
      }
    }

    function toggleSliders(mode, serviceName) {
      if (serviceName === 'LED Service') {
        const brightnessGroup = document.getElementById('ledBrightnessGroup');
        const luxRangeGroup = document.getElementById('ledLuxRangeGroup');
        const micThresholdGroup = document.getElementById('ledMicThresholdGroup');
        brightnessGroup.style.display = (mode === 'Manual LED') ? 'block' : 'none';
        luxRangeGroup.style.display = (mode === 'Lux sensor' || mode === 'Lighting LED') ? 'block' : 'none';
        micThresholdGroup.style.display = (mode === 'Musical LED') ? 'block' : 'none';
      } else if (serviceName === 'Radio Service') {
        const directionGroup = document.getElementById('searchDirectionGroup');
        directionGroup.style.display = (mode === 'Search') ? 'block' : 'none';
      } else if (serviceName === 'Fan Service') {
        const speedGroup = document.getElementById('fanSpeedGroup');
        speedGroup.style.display = (mode === 'Fixed') ? 'block' : 'none';
      }
    }

    function setDirection(direction) {
      const directionSelect = document.querySelector('select[name="direction"]');
      if (directionSelect) {
        directionSelect.value = direction;
      }
    }

    function toggleMinimumBrightness(mode) {
      const minimumBrightnessGroup = document.getElementById('minimumBrightnessGroup');
      if (minimumBrightnessGroup) {
        minimumBrightnessGroup.style.display = (mode === 'minimum') ? 'block' : 'none';
      }
    }

    // Continuous search function removed - only Fixed and Scan modes supported

    // Old button-based scan functions removed - now using mode selector

    function displayFoundStations(stations) {
      const stationsContainer = document.getElementById('stationsContainer');

      if (stations.length === 0) {
        stationsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;">No stations found with sufficient signal strength</div>';
        return;
      }

      let html = '<div style="display: grid; gap: 8px;">';
      stations.forEach(station => {
        const signalBars = '█'.repeat(Math.min(5, Math.floor(station.signal / 3)));
        const stereoIcon = station.stereo ? '🎵' : '📻';
        const qualityColor = station.signal >= 12 ? '#10b981' : station.signal >= 9 ? '#f59e0b' : '#6b7280';

        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s;"
               onclick="tuneToStation(${station.frequency})"
               onmouseover="this.style.backgroundColor='#f3f4f6'"
               onmouseout="this.style.backgroundColor='white'">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 16px;">${stereoIcon}</span>
              <div>
                <div style="font-weight: bold; color: #1f2937;">${station.frequency} MHz</div>
                <div style="font-size: 12px; color: #6b7280;">${station.quality}</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: ${qualityColor}; font-family: monospace; font-size: 12px;">${signalBars}</span>
              <span style="color: #6b7280; font-size: 12px;">${station.signal}/15</span>
            </div>
          </div>
        `;
      });
      html += '</div>';

      stationsContainer.innerHTML = html;
    }

    function tuneToStation(frequency) {
      const formData = new FormData();
      formData.append('mode', 'Fixed');
      formData.append('mode_selector', 'Fixed'); // Ensure mode_selector is also set to Fixed
      formData.append('frequency', frequency);
      formData.append('direction', 'Up');

      fetch('{{ url_for("save_service_config", service="Radio Service") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // Update the dropdown to show Fixed mode
          const modeSelector = document.querySelector('select[name="mode_selector"]');
          if (modeSelector) {
            modeSelector.value = 'Fixed';
          }
          setTimeout(() => {
            window.location.reload();
          }, 500);
        }
      })
      .catch(error => {
        console.error('Error tuning to station:', error);
      });
    }

    function stopScan() {
      fetch('/radio_stop_scan', {
        method: 'POST'
      })
      .then(response => {
        if (response.ok) {
          // Update scanning message to show stopping
          document.getElementById('stationsContainer').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Stopping scan and loading found stations...</div>';

          // Start loading stations after a short delay
          setTimeout(() => {
            loadStationsList();
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Error stopping scan:', error);
      });
    }

    function setRadioMode(mode) {
      const formData = new FormData();
      formData.append('mode', mode);
      formData.append('frequency', document.getElementById('frequencySlider').value || 99.5);
      formData.append('direction', 'Up');

      // Add loop duration if in Loop mode
      if (mode === 'Loop') {
        formData.append('loop_duration', document.getElementById('loopDurationSlider').value || 30);
      }

      // Show/hide controls based on mode
      const stationsList = document.getElementById('stationsList');
      const loopDurationGroup = document.getElementById('loopDurationGroup');
      const loopStatusGroup = document.getElementById('loopStatusGroup');

      if (mode === 'Scan') {
        stationsList.style.display = 'block';
        loopDurationGroup.style.display = 'none';
        loopStatusGroup.style.display = 'none';
        // Show scanning message with stop button
        document.getElementById('stationsContainer').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #6b7280;">
            <i class="fas fa-spinner fa-spin"></i> Scanning entire FM band (87-108 MHz)...
            <br><br>
            <button onclick="stopScan()" class="btn btn-secondary" style="background: #dc2626; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
              <i class="fas fa-stop"></i> Stop Scan
            </button>
          </div>
        `;
      } else if (mode === 'Loop') {
        stationsList.style.display = 'block';
        loopDurationGroup.style.display = 'block';
        loopStatusGroup.style.display = 'block';
        // Show loop mode message
        document.getElementById('stationsContainer').innerHTML = `
          <div style="text-align: center; padding: 20px; color: #6b7280;">
            <i class="fas fa-sync fa-spin"></i> Starting Loop mode...
            <br><br>
            <div style="font-size: 12px;">Will cycle through found stations every ${document.getElementById('loopDurationSlider').value || 30} seconds</div>
          </div>
        `;
        // Load any existing stations
        loadStationsList();
      } else {
        // Fixed mode
        stationsList.style.display = 'block';
        loopDurationGroup.style.display = 'none';
        loopStatusGroup.style.display = 'none';
        // Load any existing stations when switching to manual mode
        loadStationsList();
      }

      fetch('{{ url_for("save_service_config", service="Radio Service") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          // For scan mode, wait longer and then load results
          if (mode === 'Scan') {
            setTimeout(() => {
              loadStationsList();
            }, 2000); // Check for results every 2 seconds
          } else if (mode === 'Loop') {
            // For loop mode, wait a bit then reload to get updated status
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            setTimeout(() => {
              window.location.reload();
            }, 500);
          }
        }
      })
      .catch(error => {
        console.error('Error setting radio mode:', error);
      });
    }

    function updateLoopDuration() {
      const duration = document.getElementById('loopDurationSlider').value;
      const formData = new FormData();
      formData.append('mode', 'Loop');
      formData.append('loop_duration', duration);
      formData.append('frequency', document.getElementById('frequencySlider').value || 99.5);
      formData.append('direction', 'Up');

      fetch('{{ url_for("save_service_config", service="Radio Service") }}', {
        method: 'POST',
        body: formData
      })
      .then(response => {
        if (response.ok) {
          console.log('Loop duration updated to:', duration, 'seconds');
        }
      })
      .catch(error => {
        console.error('Error updating loop duration:', error);
      });
    }

    function updateLoopDurationSlider() {
      const slider = document.getElementById('loopDurationSlider');
      const valueDisplay = document.getElementById('loopDurationValue');

      if (slider && valueDisplay) {
        const value = slider.value;
        valueDisplay.textContent = value + 's';  // Always show 's' for seconds
      }
    }

    function loadStationsList() {
      fetch('/radio_scan_partial', {
        method: 'GET'
      })
      .then(response => response.json())
      .then(data => {
        if (data.stations && data.stations.length > 0) {
          displayFoundStations(data.stations);
        } else if (data.partial && !data.stations) {
          // No stations found yet, show message
          document.getElementById('stationsContainer').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><i class="fas fa-search"></i> No previous scan results. Start a new scan to see stations.</div>';
        } else {
          // Still scanning, check again in 2 seconds
          setTimeout(loadStationsList, 2000);
        }
      })
      .catch(error => {
        console.error('Error loading stations list:', error);
        document.getElementById('stationsContainer').innerHTML = '<div style="text-align: center; padding: 20px; color: #6b7280;"><i class="fas fa-search"></i> No previous scan results. Start a new scan to see stations.</div>';
      });
    }

    // Save scroll position before form submission
    function saveScrollPosition() {
      sessionStorage.setItem('scrollPosition', window.scrollY);
    }

    // Restore scroll position after page load
    function restoreScrollPosition() {
      const scrollPosition = sessionStorage.getItem('scrollPosition');
      if (scrollPosition) {
        window.scrollTo(0, parseInt(scrollPosition));
        sessionStorage.removeItem('scrollPosition');
      }
    }

    // Handle broadcast control actions with AJAX to prevent page refresh
    function handleBroadcastControl(event, action) {
      event.preventDefault();
      saveScrollPosition();
      
      fetch('/broadcast_control/' + action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        }
      }).then(response => {
        if (response.ok) {
          // Reload only the broadcast status section after a short delay
          setTimeout(function() {
            window.location.reload();
          }, 500);
        }
      }).catch(error => {
        console.error('Error:', error);
        window.location.reload(); // Fallback to regular reload
      });
    }

    // Handle service start/stop actions with scroll preservation
    function handleServiceAction(event, form) {
      saveScrollPosition();
      // Allow form to submit normally but preserve scroll position
      return true;
    }

    window.onload = function() {
      // Restore scroll position if returning from form submission
      restoreScrollPosition();

      updateSliderValue('brightnessSlider', 'brightnessValue');
      updateSliderValue('frequencySlider', 'frequencyValue');
      updateSliderValue('speedSlider', 'speedValue');
      updateSliderValue('volumeSlider', 'volumeValue');
      updateSliderValue('masterVolumeSlider', 'masterVolumeValue');
      updateSliderValue('micVolumeSlider', 'micVolumeValue');
      updateSliderValue('recordingDurationSlider', 'recordingDurationValue');
      updateSliderValue('luxMinSlider', 'luxMinValue');
      updateSliderValue('luxMaxSlider', 'luxMaxValue');

      // Always try to load stations list for radio service
      const stationsList = document.getElementById('stationsList');
      if (stationsList) {
        loadStationsList();
      }

      // Update hidden mode field based on mode selector
      const modeSelector = document.querySelector('select[name="mode_selector"]');
      const hiddenMode = document.getElementById('hiddenMode');
      if (modeSelector && hiddenMode) {
        hiddenMode.value = modeSelector.value;
        modeSelector.addEventListener('change', function() {
          hiddenMode.value = this.value;
        });
      }
      
      // Add scroll preservation to all forms except broadcast controls
      document.querySelectorAll('form').forEach(function(form) {
        const actionUrl = form.getAttribute('action');
        
        // Handle broadcast controls with AJAX
        if (actionUrl && actionUrl.includes('/broadcast_control/')) {
          const action = actionUrl.split('/').pop();
          form.addEventListener('submit', function(e) {
            handleBroadcastControl(e, action);
          });
        } 
        // Handle other forms with scroll preservation
        else if (!actionUrl || !actionUrl.includes('upload_broadcast_file') && !actionUrl.includes('delete_broadcast_file')) {
          form.addEventListener('submit', function(e) {
            handleServiceAction(e, form);
          });
        }
        // File upload and delete still need scroll preservation
        else {
          form.addEventListener('submit', function(e) {
            saveScrollPosition();
          });
        }
      });
      
      // Auto-refresh page every 15 seconds to update service statuses
      setTimeout(function() {
        saveScrollPosition();
        window.location.reload();
      }, 15000);
      
      // Add click handlers for health indicators to show more details
      document.querySelectorAll('.health-indicator').forEach(function(indicator) {
        indicator.style.cursor = 'pointer';
        indicator.addEventListener('click', function() {
          const issues = this.querySelector('.health-issues');
          if (issues) {
            issues.style.display = issues.style.display === 'none' ? 'block' : 'none';
          }
        });
      });
    };

    // Function to check service health via API
    function checkServiceHealth(serviceName) {
      fetch(`/health/${serviceName}`)
        .then(response => response.json())
        .then(data => {
          console.log(`Health for ${serviceName}:`, data);
        })
        .catch(error => {
          console.error(`Error checking health for ${serviceName}:`, error);
        });
    }


  </script>


</body>
</html>